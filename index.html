<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat 3D - Encrypted Group Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000000;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .chat-container {
            perspective: 1000px;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-interface {
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            background: #111111;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        @keyframes float {
            0%, 100% { transform: rotateX(5deg) rotateY(-2deg) translateY(0px); }
            50% { transform: rotateX(5deg) rotateY(-2deg) translateY(-10px); }
        }

        .chat-header {
            background: #000000;
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-3d {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotateY(20deg) rotateX(10deg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: rotateY(20deg) rotateX(10deg) scale(1); }
            50% { transform: rotateY(20deg) rotateX(10deg) scale(1.1); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        .encryption-badge {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { box-shadow: 0 0 20px rgba(56, 239, 125, 0.3); }
            50% { box-shadow: 0 0 30px rgba(56, 239, 125, 0.6); }
        }

        .chat-messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .chat-messages::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-50%);
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            animation: messageSlide 0.5s ease-out;
            position: relative;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(30px) rotateX(30deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotateX(0);
            }
        }

        .message.own {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            transform: rotateY(15deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .message-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 20px 5px;
            padding: 15px 20px;
            max-width: 60%;
            color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: rotateY(-2deg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .message.own .message-content {
            background: #333333;
            border-radius: 20px 20px 5px 20px;
            color: #ffffff;
        }

        .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        .encryption-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            color: rgba(56, 239, 125, 0.8);
            margin-left: 10px;
        }

        .chat-input {
            padding: 25px 30px;
            background: #000000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            background: #222222;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 15px 50px 15px 20px;
            color: #ffffff;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input::placeholder {
            color: #ffffff;
        }

        .message-input:focus {
            border-color: rgba(79, 172, 254, 0.8);
            box-shadow: 0 0 30px rgba(79, 172, 254, 0.3);
            transform: translateY(-2px);
        }

        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .send-button:hover {
            transform: translateY(-50%) scale(1.1) rotateZ(360deg);
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.6);
        }

        .join-section {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: rotateY(-10deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .join-link {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .copy-button, .share-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
            transition: all 0.3s ease;
        }

        .copy-button:hover, .share-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(56, 239, 125, 0.4);
        }

        .participants-count {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-members {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .member-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
        }

        .member-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 10px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #38ef7d;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float-particle 10s infinite linear;
        }

        @keyframes float-particle {
            0% {
                transform: translateY(100vh) translateX(0) rotateZ(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotateZ(360deg);
                opacity: 0;
            }
        }

        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .welcome-content {
            text-align: center;
            color: white;
            transform: rotateX(10deg);
        }

        .welcome-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .username-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 15px 25px;
            color: white;
            font-size: 16px;
            outline: none;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            text-align: center;
            min-width: 250px;
        }

        .username-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .join-chat-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 25px;
            padding: 15px 40px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.4);
            margin-top: 20px;
        }

        .join-chat-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 20px 45px rgba(79, 172, 254, 0.6);
        }

        .exit-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4);
            display: none;
            align-items: center;
            gap: 8px;
        }

        .exit-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 71, 87, 0.6);
        }

        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .share-modal-content {
            background: #111111;
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .share-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .share-option {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .share-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .chat-interface {
                height: 100vh;
                border-radius: 0;
                transform: none;
                animation: none;
            }
            
            .join-section {
                position: relative;
                top: auto;
                right: auto;
                margin: 20px;
                transform: none;
            }
            
            .message-content {
                max-width: 80%;
            }
            
            .welcome-title {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Particles -->
    <div class="floating-particles" id="particles"></div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <h1 class="welcome-title">SecureChat 3D</h1>
            <p style="font-size: 1.25rem; margin-bottom: 1.5rem; color: white;">End-to-End Encrypted Group Chat</p>
            <input type="text" id="usernameInput" class="username-input" placeholder="Enter your username" maxlength="20">
            <br>
            <button class="join-chat-button" onclick="joinChat()">
                <i class="fas fa-lock" style="margin-right: 0.5rem;"></i>
                Join Secure Chat
            </button>
        </div>
    </div>

    <!-- Exit Button -->
    <button class="exit-button" id="exitButton" onclick="exitChat()">
        <i class="fas fa-sign-out-alt"></i>
        Exit Chat
    </button>

    <!-- Share Modal -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <button class="close-modal" onclick="closeShareModal()">&times;</button>
            <h2 style="color: white; margin-bottom: 20px;">Share Chat Room</h2>
            <div class="join-link" id="shareLink" style="margin-bottom: 20px;"></div>
            <div class="share-options">
                <button class="share-option" onclick="shareViaWhatsApp()">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="share-option" onclick="shareViaTelegram()">
                    <i class="fab fa-telegram"></i> Telegram
                </button>
                <button class="share-option" onclick="shareViaEmail()">
                    <i class="fas fa-envelope"></i> Email
                </button>
                <button class="share-option" onclick="shareViaSMS()">
                    <i class="fas fa-sms"></i> SMS
                </button>
                <button class="share-option" onclick="copyShareLink()">
                    <i class="fas fa-copy"></i> Copy Link
                </button>
            </div>
        </div>
    </div>

    <!-- Join Link Section -->
    <div class="join-section" id="joinSection" style="display: none;">
        <h3 style="color: white; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">
            <i class="fas fa-share-alt" style="margin-right: 0.5rem;"></i>
            Invite Friends
        </h3>
        <div class="join-link" id="joinLink"></div>
        <button class="copy-button" onclick="copyJoinLink()">
            <i class="fas fa-copy" style="margin-right: 0.25rem;"></i>
            Copy Link
        </button>
        <button class="share-button" onclick="openShareModal()">
            <i class="fas fa-share" style="margin-right: 0.25rem;"></i>
            Share Chat
        </button>
        <div class="participants-count" style="margin-top: 0.75rem;">
            <i class="fas fa-users"></i>
            <span id="participantCount">1</span> online
        </div>
        <div class="online-members">
            <h4 style="color: white; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem;">Online Members</h4>
            <div class="member-list" id="memberList">
                <!-- Members will be populated here -->
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer" style="display: none;">
        <div class="chat-interface">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-title">
                    <div class="logo-3d">
                        <i class="fas fa-shield-alt" style="color: white; font-size: 1.25rem;"></i>
                    </div>
                    <div>
                        <h1 style="color: white; font-size: 1.5rem; font-weight: 700;">SecureChat 3D</h1>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem;">End-to-End Encrypted</p>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="encryption-badge">
                        <i class="fas fa-lock"></i>
                        <span>E2E Encrypted</span>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome message -->
                <div class="message">
                    <div class="message-avatar">🛡️</div>
                    <div class="message-content">
                        <p>Welcome to SecureChat 3D! Your messages are end-to-end encrypted.</p>
                        <div class="message-time">
                            System • <span class="encryption-indicator"><i class="fas fa-lock"></i> Encrypted</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" id="messageInput" class="message-input" placeholder="Type your encrypted message..." maxlength="500">
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for real-time chat
        let currentUser = '';
        let chatRoom = '';
        let messageHistory = [];
        let participants = new Set();
        let chatData = {};
        let isHost = false;
        let database = null;

        // Use a simpler approach with a free JSON storage API for cross-device communication
        const JSONBIN_API_KEY = '$2b$10$5Y6L.e0H0v5C5r8E8u9J3eL.r4G8k7H4k6F9d2M1m8K3s7A9d6F2';
        const CHAT_API_URL = 'https://api.jsonbin.io/v3/b/';
        let binId = null;
        let useAPI = true;

        // Initialize real-time communication
        console.log('Initializing cross-device chat system...');

        // Enhanced real-time communication system for cross-device chat
        async function saveToStorage() {
            if (useAPI && chatRoom) {
                try {
                    const data = {
                        room: chatRoom,
                        participants: Array.from(participants),
                        messages: messageHistory,
                        lastUpdate: Date.now(),
                        users: {}
                    };
                    
                    // Add current user to active users
                    data.users[currentUser] = {
                        username: currentUser,
                        lastSeen: Date.now(),
                        active: true
                    };
                    
                    // Merge with existing users
                    if (window.currentChatData && window.currentChatData.users) {
                        Object.keys(window.currentChatData.users).forEach(user => {
                            if (user !== currentUser && (Date.now() - window.currentChatData.users[user].lastSeen) < 60000) {
                                data.users[user] = window.currentChatData.users[user];
                            }
                        });
                    }
                    
                    const apiUrl = binId ? 
                        `${CHAT_API_URL}${binId}` : 
                        `${CHAT_API_URL}`;
                    
                    const response = await fetch(apiUrl, {
                        method: binId ? 'PUT' : 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY,
                            'X-Bin-Name': `chat_${chatRoom}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (!binId && result.metadata && result.metadata.id) {
                            binId = result.metadata.id;
                            localStorage.setItem(`binId_${chatRoom}`, binId);
                        }
                        window.currentChatData = data;
                        console.log('Chat data saved successfully');
                    }
                } catch (error) {
                    console.log('API save failed, using localStorage fallback');
                    saveToLocalStorage();
                }
            } else {
                saveToLocalStorage();
            }
        }
        
        function saveToLocalStorage() {
            const data = {
                room: chatRoom,
                participants: Array.from(participants),
                messages: messageHistory,
                lastUpdate: Date.now(),
                users: {}
            };
            
            data.users[currentUser] = {
                username: currentUser,
                lastSeen: Date.now(),
                active: true
            };
            
            localStorage.setItem(`chat_${chatRoom}`, JSON.stringify(data));
        }

        async function loadFromStorage() {
            // Try to get binId for this room
            binId = localStorage.getItem(`binId_${chatRoom}`);
            
            if (useAPI && binId) {
                try {
                    const response = await fetch(`${CHAT_API_URL}${binId}/latest`, {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const data = result.record;
                        
                        if (data && data.room === chatRoom) {
                            window.currentChatData = data;
                            
                            const oldLength = messageHistory.length;
                            messageHistory = data.messages || [];
                            
                            // Update participants from API data
                            participants.clear();
                            if (data.users) {
                                Object.values(data.users).forEach(user => {
                                    if ((Date.now() - user.lastSeen) < 60000) { // Active within 1 minute
                                        participants.add(user.username);
                                    }
                                });
                            }
                            
                            if (oldLength === 0) {
                                displayAllMessages();
                            } else if (messageHistory.length > oldLength) {
                                // Show new messages
                                const newMessages = messageHistory.slice(oldLength);
                                newMessages.forEach(msg => {
                                    if (msg.sender !== currentUser) {
                                        if (msg.type === 'system') {
                                            addSystemMessage(msg.message, false);
                                        } else {
                                            addMessage(msg.sender, msg.message, false, false);
                                        }
                                    }
                                });
                            }
                            
                            updateParticipantCount();
                            console.log('Chat data loaded from API');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('API load failed, using localStorage');
                }
            }
            
            // Fallback to localStorage
            loadFromLocalStorage();
        }
        
        function loadFromLocalStorage() {
            const stored = localStorage.getItem(`chat_${chatRoom}`);
            if (stored) {
                const data = JSON.parse(stored);
                window.currentChatData = data;
                participants = new Set(data.participants || []);
                messageHistory = data.messages || [];
                displayAllMessages();
                updateParticipantCount();
            } else {
                displayAllMessages();
            }
        }
        
        function displayAllMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message">
                    <div class="message-avatar">🛡️</div>
                    <div class="message-content">
                        <p>Welcome to SecureChat 3D! Your messages are end-to-end encrypted.</p>
                        <div class="message-time">
                            System • <span class="encryption-indicator"><i class="fas fa-lock"></i> Encrypted</span>
                        </div>
                    </div>
                </div>
            `;
            
            messageHistory.forEach(msg => {
                if (msg.type === 'system') {
                    addSystemMessage(msg.message, false);
                } else {
                    addMessage(msg.sender, msg.message, msg.sender === currentUser, false);
                }
            });
        }

        // Enhanced communication setup for real group chat
        function setupCommunication() {
            // Real-time polling for cross-device updates
            setInterval(pollForUpdates, 2000); // Poll every 2 seconds
            
            // Update user presence every 10 seconds
            setInterval(updateUserPresence, 10000);
            
            // Clean up inactive users every 30 seconds
            setInterval(cleanupInactiveUsers, 30000);
            
            // Local storage listener for same-browser tabs
            window.addEventListener('storage', function(e) {
                if (e.key === `chat_${chatRoom}` && e.newValue) {
                    const data = JSON.parse(e.newValue);
                    handleChatUpdate(data);
                }
            });
            
            console.log('Real-time communication setup complete');
        }
        
        // Update user presence
        function updateUserPresence() {
            if (currentUser && chatRoom) {
                // Update presence by saving current data
                saveToStorage();
            }
        }
        
        // Update active users list
        function updateActiveUsers() {
            const activeUsers = new Set();
            const cutoffTime = Date.now() - 30000; // 30 seconds timeout
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`user_${chatRoom}_`)) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData.lastSeen > cutoffTime) {
                            activeUsers.add(userData.username);
                        }
                    } catch (e) {
                        // Invalid data, skip
                    }
                }
            }
            
            const oldSize = participants.size;
            participants = activeUsers;
            
            if (participants.size !== oldSize) {
                updateParticipantCount();
            }
        }
        
        // Clean up inactive users
        function cleanupInactiveUsers() {
            const cutoffTime = Date.now() - 60000; // 1 minute timeout
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`user_${chatRoom}_`)) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData.lastSeen < cutoffTime) {
                            localStorage.removeItem(key);
                        }
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }
            }
            updateActiveUsers();
        }
        
        function handleChatUpdate(data) {
            if (!data || !data.messages) return;
            
            const oldMessageCount = messageHistory.length;
            
            // Update active users from presence data
            updateActiveUsers();
            
            // Check for new messages only
            if (data.messages.length > oldMessageCount) {
                const newMessages = data.messages.slice(oldMessageCount);
                newMessages.forEach(msg => {
                    // Only add messages from other users (not our own)
                    if (msg.sender !== currentUser) {
                        if (msg.type === 'system') {
                            addSystemMessage(msg.message, false);
                        } else {
                            addMessage(msg.sender, msg.message, false, false);
                        }
                    }
                });
                messageHistory = data.messages;
            }
            
            updateParticipantCount();
        }
        
        async function pollForUpdates() {
            if (!binId || !useAPI) return;
            
            try {
                const response = await fetch(`${CHAT_API_URL}${binId}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const data = result.record;
                    
                    if (data && data.lastUpdate > (window.lastUpdateTime || 0)) {
                        window.lastUpdateTime = data.lastUpdate;
                        handleChatUpdate(data);
                    }
                }
            } catch (error) {
                // Silently fail and try again next time
            }
        }

        // Simple encryption simulation (for demo purposes)
        function simpleEncrypt(text) {
            return btoa(text).split('').reverse().join('');
        }

        function simpleDecrypt(text) {
            return atob(text.split('').reverse().join(''));
        }

        // Generate room ID from URL or create new one
        function generateRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                return roomParam;
            } else {
                return 'room_' + Math.random().toString(36).substr(2, 9);
            }
        }

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (5 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Join chat function
        function joinChat() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            currentUser = username;
            chatRoom = generateRoomId();
            participants.add(currentUser);

            // Hide welcome screen and show chat
            document.getElementById('welcomeScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
                document.getElementById('joinSection').style.display = 'block';
                document.getElementById('exitButton').style.display = 'flex';
            }, 500);

            // Update join link
            updateJoinLink();
            updateParticipantCount();

            // Setup communication channels
            setupCommunication();
            
            // Load existing chat data or create new room
            loadFromStorage();
            
            // Update user presence
            updateUserPresence();
            
            // Add join message
            addSystemMessage(`${currentUser} joined the chat`);

            // Focus on message input
            document.getElementById('messageInput').focus();
            
            // Set initial update time
            window.lastUpdateTime = Date.now();
        }

        // Update join link - blogger compatible
        function updateJoinLink() {
            let baseUrl;
            try {
                baseUrl = window.location.origin + window.location.pathname;
            } catch (e) {
                // Fallback for environments without full URL access
                baseUrl = window.location.href.split('?')[0];
            }
            const joinUrl = `${baseUrl}?room=${chatRoom}`;
            document.getElementById('joinLink').textContent = joinUrl;
        }

        // Copy join link
        function copyJoinLink() {
            const joinLink = document.getElementById('joinLink').textContent;
            navigator.clipboard.writeText(joinLink).then(() => {
                const button = event.target.closest('.copy-button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check" style="margin-right: 0.25rem;"></i> Copied!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }

        // Exit chat function
        function exitChat() {
            if (confirm('Are you sure you want to exit the chat?')) {
                // Add leave message before removing user
                addSystemMessage(`${currentUser} left the chat`);
                
                // Remove user presence data
                localStorage.removeItem(`user_${chatRoom}_${currentUser}`);
                
                // Close BroadcastChannel if it exists
                if (window.chatChannel) {
                    window.chatChannel.close();
                }
                
                // Reset and go back to welcome screen
                location.reload();
            }
        }

        // Open share modal
        function openShareModal() {
            const shareLink = document.getElementById('shareLink');
            const joinLink = document.getElementById('joinLink').textContent;
            shareLink.textContent = joinLink;
            document.getElementById('shareModal').style.display = 'flex';
        }

        // Close share modal
        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        // Share via WhatsApp
        function shareViaWhatsApp() {
            const link = document.getElementById('joinLink').textContent;
            const text = `Join our secure encrypted chat room!\n\n${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // Share via Telegram
        function shareViaTelegram() {
            const link = document.getElementById('joinLink').textContent;
            const text = `Join our secure encrypted chat room! ${link}`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`, '_blank');
        }

        // Share via Email
        function shareViaEmail() {
            const link = document.getElementById('joinLink').textContent;
            const subject = 'Join SecureChat 3D - Encrypted Group Chat';
            const body = `Hi!\n\nYou're invited to join our secure encrypted chat room.\n\nClick here to join: ${link}\n\nSee you there!`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        // Share via SMS
        function shareViaSMS() {
            const link = document.getElementById('joinLink').textContent;
            const text = `Join our secure chat: ${link}`;
            window.open(`sms:?body=${encodeURIComponent(text)}`);
        }

        // Copy share link
        function copyShareLink() {
            const link = document.getElementById('joinLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        // Legacy share function (keep for compatibility)
        function shareJoinLink() {
            openShareModal();
        }

        // Update participant count and member list
        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = participants.size;
            updateMemberList();
        }

        // Update online member list
        function updateMemberList() {
            const memberList = document.getElementById('memberList');
            if (!memberList) return;
            
            memberList.innerHTML = '';
            
            Array.from(participants).forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                const avatar = member.charAt(0).toUpperCase();
                
                memberItem.innerHTML = `
                    <div class="member-avatar">${avatar}</div>
                    <span>${member}</span>
                    <div class="online-dot"></div>
                `;
                
                memberList.appendChild(memberItem);
            });
        }

        // Send message function
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;

            // Encrypt message (simulation)
            const encryptedMessage = simpleEncrypt(messageText);
            
            // Add message to chat
            addMessage(currentUser, messageText, true);
            
            // Clear input
            messageInput.value = '';

            // No simulation - real messages only
        }

        // Add message to chat
        function addMessage(sender, message, isOwn = false, saveToHistory = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : ''}`;

            const avatar = sender.charAt(0).toUpperCase();
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <p>${message}</p>
                    <div class="message-time">
                        ${sender} • ${timestamp}<span class="encryption-indicator"><i class="fas fa-lock"></i> Encrypted</span>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Store in history and save to storage
            if (saveToHistory) {
                messageHistory.push({sender, message, timestamp, type: 'message'});
                saveToStorage();
            }
        }

        // Add system message
        function addSystemMessage(message, saveToHistory = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            messageDiv.innerHTML = `
                <div class="message-avatar">🔔</div>
                <div class="message-content">
                    <p style="font-style: italic; opacity: 0.8;">${message}</p>
                    <div class="message-time">
                        System • ${timestamp}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Store in history and save to storage
            if (saveToHistory) {
                messageHistory.push({message, timestamp, type: 'system'});
                saveToStorage();
            }
        }

        // Simulate other user messages
        function simulateOtherUserMessage() {
            const otherUsers = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eva'];
            const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
            
            if (!participants.has(randomUser)) {
                participants.add(randomUser);
                updateParticipantCount();
                addSystemMessage(`${randomUser} joined the chat`);
            }

            const sampleMessages = [
                "Hey everyone! 👋",
                "This 3D interface looks amazing!",
                "Love the encryption feature",
                "Anyone up for a video call later?",
                "The floating particles are so cool",
                "Great to see everyone here",
                "This chat feels so secure",
                "The 3D effects are impressive",
                "Thanks for sharing the link!",
                "How's everyone doing?"
            ];

            const randomMessage = sampleMessages[Math.floor(Math.random() * sampleMessages.length)];
            
            setTimeout(() => {
                addMessage(randomUser, randomMessage, false);
            }, 500);
        }

        // Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinChat();
                }
            });

            // Create particles
            createParticles();

            // Check if joining via link
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('room')) {
                // Auto-focus username input if joining via link
                document.getElementById('usernameInput').focus();
            }
        });

        // Add some visual feedback for encryption
        setInterval(() => {
            const encryptionBadge = document.querySelector('.encryption-badge');
            if (encryptionBadge) {
                encryptionBadge.style.animation = 'none';
                setTimeout(() => {
                    encryptionBadge.style.animation = 'shimmer 3s infinite';
                }, 10);
            }
        }, 15000);

        // Add typing indicator simulation
        function showTypingIndicator(user) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing-indicator';
            typingDiv.id = `typing-${user}`;

            typingDiv.innerHTML = `
                <div class="message-avatar">${user.charAt(0).toUpperCase()}</div>
                <div class="message-content" style="opacity: 0.7;">
                    <p><i>${user} is typing...</i></p>
                </div>
            `;

            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Remove after 3 seconds
            setTimeout(() => {
                const indicator = document.getElementById(`typing-${user}`);
                if (indicator) {
                    indicator.remove();
                }
            }, 3000);
        }

        // Occasionally show typing indicators
        setInterval(() => {
            if (participants.size > 1 && Math.random() < 0.2) {
                const users = Array.from(participants).filter(u => u !== currentUser);
                if (users.length > 0) {
                    const randomUser = users[Math.floor(Math.random() * users.length)];
                    showTypingIndicator(randomUser);
                }
            }
        }, 20000);
    </script>
</body>
</html>







